!function(t){"function"==typeof define&&define.amd?define(t):t()}((function(){"use strict";const t=16,e=function(t,e,n,r=1){const o=t.getContext("2d"),a=(t=>(window.devicePixelRatio||1)/(t.webkitBackingStorePixelRatio||t.mozBackingStorePixelRatio||t.msBackingStorePixelRatio||t.oBackingStorePixelRatio||t.backingStorePixelRatio||1))(o);return t.width=e*a,t.height=n*a,t.style.width="100%",t.style.maxWidth=e*r+"px",o.setTransform(a,0,0,a,0,0),t},n=(t,e)=>{const n=new Image;return n.src=t,e&&n.addEventListener("load",(()=>e(n)),!1),n},r=(t,e,n=e)=>(r,o,a,i,s)=>r.drawImage(t,o*e,a*n,e,n,i*e,s*n,e,n),o=(t,e,n=e)=>{const r=t.width/e;let o=Math.floor(Math.random()*r);if(r>0){setInterval((()=>{o=(o+1)%r}),125)}return(r,a,i)=>r.drawImage(t,o*e,0,e,n,a*e,i*n,e,n)},a=(t,e=.2)=>(void 0===t.drawX&&(t.drawX=t.x),void 0===t.drawY&&(t.drawY=t.y),t.drawX<t.x&&(t.drawX+=Math.min(t.x-t.drawX,e)),t.drawY<t.y&&(t.drawY+=Math.min(t.y-t.drawY,e)),t.drawX>t.x&&(t.drawX-=Math.min(t.drawX-t.x,e)),t.drawY>t.y&&(t.drawY-=Math.min(t.drawY-t.y,e)),[t.drawX,t.drawY]);function i(t){for(var e=t.length-1;e>0;e--){var n=Math.floor(Math.random()*(e+1)),r=t[e];t[e]=t[n],t[n]=r}}const s=t=>t[Math.floor(Math.random()*t.length)],d=n("img/tiles.png"),c=n("img/bat.png"),l=n("img/skeleton.png"),m=n("img/knight.png"),u=n("img/knight_flip.png"),y=n("img/slime.png"),h=n("img/coin.png"),f=n("img/potion.png"),x=r(d,t),w=(t,e)=>{const n=[[t.x-1,t.y],[t.x,t.y-1],[t.x+1,t.y],[t.x,t.y+1]].filter((([t,n])=>e(t,n))),r=s(n);return r&&{type:"Move",x:r[0],y:r[1]}},g=(t,e,n)=>{const r=[[t.x-1,t.y],[t.x,t.y-1],[t.x+1,t.y],[t.x,t.y+1],[t.x+(t.x>e.x?-1:1),t.y],[t.x,t.y+(t.y>e.y?-1:1)]].filter((([t,e])=>n(t,e))),o=s(r);return o&&{type:"Move",x:o[0],y:o[1]}},p=({me:t,isFreeAt:e})=>Math.random()>.5?[w(t,e)]:[],M=({me:t,player:e,isFreeAt:n})=>[g(t,e,n)],E=({me:t,isFreeAt:e})=>{const n=[];return t.grow++,8===t.grow&&n.push({type:"Spawn",make:B}),n.push(w(t,e)),n},v=(e,n)=>({name:"Coin",draw:o(h,t),sort:5,x:e,y:n}),k=(e,n)=>({name:"Potion",draw:o(f,t),sort:5,x:e,y:n}),S=(e,n)=>({name:"Bat",draw:o(c,t),turn:p,x:e,y:n}),b=(e,n)=>({name:"Skeleton",draw:o(l,t),turn:M,x:e,y:n}),B=(e,n)=>({name:"Slime",draw:o(y,t),turn:E,grow:0,x:e,y:n}),X=t=>{switch(t){case 1:case 2:return S;case 3:case 4:return s([S,S,b]);case 5:case 6:return s([S,b]);case 7:case 8:return s([S,S,S,S,b,b,b,b,b,B]);case 9:case 10:case 11:case 12:return s([S,S,S,b,b,b,b,B,B,B]);default:return s([S,b,b,B,B])}};let Y,C,I,R,P,A,L,F,$,j,O={};const q=()=>{document.getElementById("floor-hud").textContent=`${F}`,document.getElementById("coins-hud").textContent=`${$}`,document.getElementById("lives-hud").textContent=`${j}`},z=t=>{I.push(t),I.sort(((t,e)=>(e.sort||0)-(t.sort||0)))},K=(t,e)=>I.find((n=>n.x===t&&n.y===e)),T=t=>{I=I.filter((e=>e!==t))},W=(t,e)=>0===t||0===e||7===t||9===e,_=(t,e)=>{if(W(t,e))return!1;const n=K(t,e);return!n||"Stairs"!==n.name};function D(){L=((e,n)=>{const r=[o(m,t),o(u,t)],a={name:"Knight",x:e,y:n,dir:0,draw:(...t)=>r[a.dir](...t)};return a})(2,2),P=!1,F=0,$=0,j=5,G()}function G(){R=!1,A=1.5,I=[],F++,q();const t=((t,e,n,r)=>{const o=[];for(let a=e;a<r;a++)for(let e=t;e<n;e++)o.push([e,a]);return i(o),o})(1,1,7,9).filter((([t,e])=>Math.abs(t-L.x)>1||Math.abs(e-L.y)>1)),[e,n]=t.pop();z({name:"Stairs",draw:(t,e,n)=>x(t,8,1,e,n),sort:10,x:e,y:n});((t,e)=>{const n=[];for(let e=0;e<t/5;e++)n.push(v);for(let e=0;e<t-1;e++)n.push(X(t));i(n),t%5==0&&n.unshift(k);const r=Math.min(t<4?t:3+t/4,e/4.5);return n.slice(0,r)})(F,t.length).forEach((e=>{const[n,r]=t.pop();z(e(n,r))}))}window.addEventListener("keydown",(function(t){O[t.keyCode]=!0})),window.addEventListener("keyup",(function(t){O[t.keyCode]=!1})),(t=>{let e=null,n=null;document.addEventListener("touchstart",(t=>{const r=t.touches[0];e=r.clientX,n=r.clientY}),!1),document.addEventListener("touchmove",(r=>{if(!e||!n)return;const o=r.touches[0].clientX,a=r.touches[0].clientY,i=e-o,s=n-a;Math.abs(i)>Math.abs(s)?t(i>0?37:39):t(s>0?38:40),e=null,n=null}),!1)})((t=>{O[t]=!0})),window.addEventListener("load",(function(){Y=((t,n,r,o)=>{const a=document.getElementById(t);e(a,n,r,o);const i=a.getContext("2d");return a.style.imageRendering="pixelated",i.imageSmoothingEnabled=!1,i})("root",128,160,3.5),C=r(d,t),D(),N()}));const H={37:()=>{W(L.x-1,L.y)||L.x--,L.dir=1},38:()=>{W(L.x,L.y-1)||L.y--},39:()=>{W(L.x+1,L.y)||L.x++,L.dir=0},40:()=>{W(L.x,L.y+1)||L.y++}};function J(t){"Stairs"===t.name&&(R=!0,(()=>{const t=document.getElementById("extra-hud");t.style.opacity="0",t.style.pointerEvents="none"})()),"Coin"===t.name&&($++,q(),T(t)),"Potion"===t.name&&(j++,q(),T(t)),"Slime"!==t.name&&"Bat"!==t.name&&"Skeleton"!==t.name||(j--,q(),j<=0&&(P=!0),T(t))}function N(){P||R||Object.entries(H).forEach((([t,e])=>{if(O[t]){O[t]=!1,e();const n=K(L.x,L.y);n&&J(n),I.filter((t=>!!t.turn)).forEach((t=>{t.turn({me:t,player:L,floor:F,isFreeAt:_}).forEach((e=>{"Move"===e.type&&(t.x=e.x,t.y=e.y),"Spawn"===e.type&&z(e.make(t.x,t.y))}))}));const r=K(L.x,L.y);r&&J(r)}})),P&&A>.9&&Object.entries(H).forEach((([t])=>{O[t]&&(O[t]=!1,D())})),Y.clearRect(0,0,128,160);for(let t=1;t<9;t++)for(let e=1;e<7;e++)C(Y,1,1,e,t);C(Y,0,0,0,0);for(let t=1;t<7;t++)C(Y,1,0,t,0);C(Y,2,0,7,0),C(Y,0,2,0,9);for(let t=1;t<7;t++)C(Y,1,2,t,9);C(Y,2,2,7,9);for(let t=0;t<9;t++)C(Y,0,1,0,t);for(let t=0;t<9;t++)C(Y,2,1,7,t);I.forEach((t=>{const[e,n]=a(t);t.draw(Y,e,n)}));const[t,e]=a(L);L.draw(Y,t,e),R?A<1?A+=Math.min(1-A,1/12):G():P?A<2&&(A+=Math.min(2-A,2/60)):A>0&&(A-=Math.min(A,1/12)),A>0&&(Y.fillStyle=`rgba(39, 29, 42, ${A})`,Y.fillRect(0,0,128,160),P&&(Y.globalAlpha=A>1?A-1:0,C(Y,17,1,3.5,4.5),Y.globalAlpha=1)),requestAnimationFrame(N)}}));
