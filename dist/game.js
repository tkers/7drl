!function(e){"function"==typeof define&&define.amd?define(e):e()}((function(){"use strict";const e=16,t=10,n=function(e,t,n,r=1){const a=e.getContext("2d"),o=(e=>(window.devicePixelRatio||1)/(e.webkitBackingStorePixelRatio||e.mozBackingStorePixelRatio||e.msBackingStorePixelRatio||e.oBackingStorePixelRatio||e.backingStorePixelRatio||1))(a);return e.width=t*o,e.height=n*o,e.style.width="100%",e.style.maxWidth=t*r+"px",a.setTransform(o,0,0,o,0,0),e},r=(e,t)=>{const n=new Image;return n.src=e,t&&n.addEventListener("load",(()=>t(n)),!1),n},a=(e,t,n=t)=>(r,a,o,i,s)=>r.drawImage(e,a*t,o*n,t,n,i*t,s*n,t,n),o=(e,t,n=t)=>{const r=e.width/t;let a=Math.floor(Math.random()*r);if(r>0){setInterval((()=>{a=(a+1)%r}),125)}return(r,o,i)=>r.drawImage(e,a*t,0,t,n,o*t,i*n,t,n)},i=(e,t=.2)=>(void 0===e.drawX&&(e.drawX=e.x),void 0===e.drawY&&(e.drawY=e.y),e.drawX<e.x&&(e.drawX+=Math.min(e.x-e.drawX,t)),e.drawY<e.y&&(e.drawY+=Math.min(e.y-e.drawY,t)),e.drawX>e.x&&(e.drawX-=Math.min(e.drawX-e.x,t)),e.drawY>e.y&&(e.drawY-=Math.min(e.drawY-e.y,t)),[e.drawX,e.drawY]);function s(e){for(var t=e.length-1;t>0;t--){var n=Math.floor(Math.random()*(t+1)),r=e[t];e[t]=e[n],e[n]=r}}const c=e=>e[Math.floor(Math.random()*e.length)],d=r("img/tiles.png"),l=r("img/bat.png"),u=r("img/skeleton.png"),m=r("img/knight.png"),y=r("img/knight_flip.png"),h=r("img/slime.png"),x=r("img/coin.png"),f=r("img/potion.png"),w=a(d,e),g=(e,t)=>{const n=[[e.x-1,e.y],[e.x,e.y-1],[e.x+1,e.y],[e.x,e.y+1]].filter((([e,n])=>t(e,n))),r=c(n);return r&&{type:"Move",x:r[0],y:r[1]}},p=(e,t,n)=>{const r=[[e.x-1,e.y],[e.x,e.y-1],[e.x+1,e.y],[e.x,e.y+1],[e.x+(e.x>t.x?-1:1),e.y],[e.x,e.y+(e.y>t.y?-1:1)]].filter((([e,t])=>n(e,t))),a=c(r);return a&&{type:"Move",x:a[0],y:a[1]}},M=({me:e,isFreeAt:t})=>Math.random()>.5?[g(e,t)]:[],E=({me:e,player:t,isFreeAt:n})=>[p(e,t,n)],v=({me:e,isFreeAt:t})=>{const n=[];return e.grow++,8===e.grow&&n.push({type:"Spawn",make:X}),n.push(g(e,t)),n},k=(t,n)=>({name:"Coin",draw:o(x,e),sort:5,x:t,y:n}),S=(t,n)=>({name:"Potion",draw:o(f,e),sort:5,x:t,y:n}),b=(t,n)=>({name:"Bat",draw:o(l,e),turn:M,x:t,y:n}),B=(t,n)=>({name:"Skeleton",draw:o(u,e),turn:E,x:t,y:n}),X=(t,n)=>({name:"Slime",draw:o(h,e),turn:v,grow:0,x:t,y:n}),Y=e=>{switch(e){case 1:case 2:return b;case 3:case 4:case 5:return c([b,b,B]);case 6:case 7:case 8:case 9:return c([b,B]);case 10:case 11:case 12:case 13:case 14:return c([b,b,b,b,B,B,B,B,B,X]);case 15:case 16:case 17:case 18:case 19:return c([b,b,b,B,B,B,B,X,X,X]);default:return c([b,B,B,X,X])}};let C,I,R,P,A,L,F,$,j,O,q={};const z=()=>{document.getElementById("floor-hud").textContent=`${$}`,document.getElementById("coins-hud").textContent=`${j}`,document.getElementById("lives-hud").textContent=`${O}`},K=e=>{R.push(e),R.sort(((e,t)=>(t.sort||0)-(e.sort||0)))},T=(e,t)=>R.find((n=>n.x===e&&n.y===t)),W=e=>{R=R.filter((t=>t!==e))},_=[[1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1]],D=(e,n)=>e>=0&&n>=0&&e<8&&n<t&&1===_[n][e],G=(e,n)=>e>=0&&n>=0&&e<8&&n<t&&0===_[n][e],H=(e,t)=>{if(D(e,t))return!1;const n=T(e,t);return!n||"Stairs"!==n.name},J=(e,t)=>G(e,t)?[1,1]:D(e,t)?((e,t)=>{switch((D(e,t-1)?1:0)+(G(e,t-1)?2:0)+(D(e+1,t)?4:0)+(G(e+1,t)?8:0)+(D(e,t+1)?16:0)+(G(e,t+1)?32:0)+(D(e-1,t)?64:0)+(G(e-1,t)?128:0)){case 20:return[0,0];case 100:return[1,0];case 80:return[2,0];case 25:return[0,1];case 145:return[2,1];case 5:return[0,2];case 70:return[1,2];case 65:return[2,2];default:return[10,0]}})(e,t):null;function N(){F=((t,n)=>{const r=[o(m,e),o(y,e)],a={name:"Knight",x:t,y:n,dir:0,draw:(...e)=>r[a.dir](...e)};return a})(2,2),A=!1,$=0,j=0,O=5,Q()}function Q(){P=!1,L=1.5,R=[],$++,z();const e=((e,t,n,r)=>{const a=[];for(let o=t;o<r;o++)for(let t=e;t<n;t++)a.push([t,o]);return s(a),a})(0,0,8,t).filter((([e,t])=>G(e,t))).filter((([e,t])=>Math.abs(e-F.x)>1||Math.abs(t-F.y)>1)),[n,r]=e.pop();K({name:"Stairs",draw:(e,t,n)=>w(e,8,1,t,n),sort:10,x:n,y:r});((e,t)=>{const n=[];for(let t=0;t<e/5;t++)n.push(k);for(let t=0;t<e-1;t++)n.push(Y(e));s(n),e%5==0&&n.unshift(S);const r=Math.min(e<4?e:3+e/4,t/4.5);return n.slice(0,r)})($,e.length).forEach((t=>{const[n,r]=e.pop();K(t(n,r))}))}window.addEventListener("keydown",(function(e){q[e.keyCode]=!0})),window.addEventListener("keyup",(function(e){q[e.keyCode]=!1})),(e=>{let t=null,n=null;document.addEventListener("touchstart",(e=>{const r=e.touches[0];t=r.clientX,n=r.clientY}),!1),document.addEventListener("touchmove",(r=>{if(!t||!n)return;const a=r.touches[0].clientX,o=r.touches[0].clientY,i=t-a,s=n-o;Math.abs(i)>Math.abs(s)?e(i>0?37:39):e(s>0?38:40),t=null,n=null}),!1)})((e=>{q[e]=!0})),window.addEventListener("load",(function(){C=((e,t,r,a)=>{const o=document.getElementById(e);n(o,t,r,a);const i=o.getContext("2d");return o.style.imageRendering="pixelated",i.imageSmoothingEnabled=!1,i})("root",128,160,3.5),I=a(d,e),N(),Z()}));const U={37:()=>{D(F.x-1,F.y)||F.x--,F.dir=1},38:()=>{D(F.x,F.y-1)||F.y--},39:()=>{D(F.x+1,F.y)||F.x++,F.dir=0},40:()=>{D(F.x,F.y+1)||F.y++}};function V(e){"Stairs"===e.name&&(P=!0,(()=>{const e=document.getElementById("extra-hud");e.style.opacity="0",e.style.pointerEvents="none"})()),"Coin"===e.name&&(j++,z(),W(e)),"Potion"===e.name&&(O++,z(),W(e)),"Slime"!==e.name&&"Bat"!==e.name&&"Skeleton"!==e.name||(O--,z(),O<=0&&(A=!0),W(e))}function Z(){A||P||Object.entries(U).forEach((([e,t])=>{if(q[e]){q[e]=!1,t();const n=T(F.x,F.y);n&&V(n),R.filter((e=>!!e.turn)).forEach((e=>{e.turn({me:e,player:F,floor:$,isFreeAt:H}).forEach((t=>{"Move"===t.type&&(e.x=t.x,e.y=t.y),"Spawn"===t.type&&K(t.make(e.x,e.y))}))}));const r=T(F.x,F.y);r&&V(r)}})),A&&L>.9&&Object.entries(U).forEach((([e])=>{q[e]&&(q[e]=!1,N())})),C.clearRect(0,0,128,160);for(let e=0;e<t;e++)for(let t=0;t<8;t++){const n=J(t,e);n&&I(C,n[0],n[1],t,e)}R.forEach((e=>{const[t,n]=i(e);e.draw(C,t,n)}));const[e,n]=i(F);F.draw(C,e,n),P?L<1?L+=Math.min(1-L,1/12):Q():A?L<2&&(L+=Math.min(2-L,2/60)):L>0&&(L-=Math.min(L,1/12)),L>0&&(C.fillStyle=`rgba(39, 29, 42, ${L})`,C.fillRect(0,0,128,160),A&&(C.globalAlpha=L>1?L-1:0,I(C,17,1,3.5,4.5),C.globalAlpha=1)),requestAnimationFrame(Z)}}));
