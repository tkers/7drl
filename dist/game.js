!function(t){"function"==typeof define&&define.amd?define(t):t()}((function(){"use strict";const t=16,e=function(t,e,n,o=1){const r=t.getContext("2d"),a=(t=>(window.devicePixelRatio||1)/(t.webkitBackingStorePixelRatio||t.mozBackingStorePixelRatio||t.msBackingStorePixelRatio||t.oBackingStorePixelRatio||t.backingStorePixelRatio||1))(r);return t.width=e*a,t.height=n*a,t.style.width="100%",t.style.maxWidth=e*o+"px",r.setTransform(a,0,0,a,0,0),t},n=(t,e)=>{const n=new Image;return n.src=t,e&&n.addEventListener("load",(()=>e(n)),!1),n},o=(t,e,n=e)=>(o,r,a,i,s)=>o.drawImage(t,r*e,a*n,e,n,i*e,s*n,e,n),r=(t,e,n=e)=>{const o=t.width/e;let r=Math.floor(Math.random()*o);if(o>0){setInterval((()=>{r=(r+1)%o}),125)}return(o,a,i)=>o.drawImage(t,r*e,0,e,n,a*e,i*n,e,n)},a=(t,e=.2)=>(void 0===t.drawX&&(t.drawX=t.x),void 0===t.drawY&&(t.drawY=t.y),t.drawX<t.x&&(t.drawX+=Math.min(t.x-t.drawX,e)),t.drawY<t.y&&(t.drawY+=Math.min(t.y-t.drawY,e)),t.drawX>t.x&&(t.drawX-=Math.min(t.drawX-t.x,e)),t.drawY>t.y&&(t.drawY-=Math.min(t.drawY-t.y,e)),[t.drawX,t.drawY]);function i(t){for(var e=t.length-1;e>0;e--){var n=Math.floor(Math.random()*(e+1)),o=t[e];t[e]=t[n],t[n]=o}}const s=t=>t[Math.floor(Math.random()*t.length)],d=n("img/tiles.png"),c=n("img/bat.png"),l=n("img/skeleton.png"),u=n("img/knight.png"),m=n("img/knight_flip.png"),h=n("img/slime.png"),y=n("img/coin.png"),x=n("img/potion.png"),f=o(d,t),w=t=>{const e=[];t.x>1&&e.push([t.x-1,t.y]),t.y>1&&e.push([t.x,t.y-1]),t.x<6&&e.push([t.x+1,t.y]),t.y<8&&e.push([t.x,t.y+1]);const n=s(e);return n&&{type:"Move",x:n[0],y:n[1]}},g=(t,e)=>{const n=[];t.x>1&&t.x>e.x&&n.push([t.x-1,t.y]),t.y>1&&t.y>e.y&&n.push([t.x,t.y-1]),t.x<6&&t.x<e.x&&n.push([t.x+1,t.y]),t.y<8&&t.y<e.y&&n.push([t.x,t.y+1]);const o=s(n);return o&&{type:"Move",x:o[0],y:o[1]}},p=({me:t})=>Math.random()>.5?[w(t)]:[],M=({me:t,player:e})=>Math.random()>.8?[g(t,e)]:[w(t)],k=({me:t,floor:e})=>{const n=[];return t.grow++,5===t.grow&&n.push({type:"Spawn",make:X}),n.push(w(t)),n},v=(e,n)=>({name:"Coin",draw:r(y,t),sort:5,x:e,y:n}),E=(e,n)=>({name:"Potion",draw:r(x,t),sort:5,x:e,y:n}),S=(e,n)=>({name:"Bat",draw:r(c,t),turn:p,x:e,y:n}),b=(e,n)=>({name:"Skeleton",draw:r(l,t),turn:M,x:e,y:n}),X=(e,n)=>({name:"Slime",draw:r(h,t),turn:k,grow:0,x:e,y:n}),Y=t=>{switch(t){case 1:case 2:return S;case 3:case 4:return s([S,S,b]);case 5:case 6:return s([S,b]);case 7:case 8:return s([S,S,S,S,b,b,b,b,b,X]);case 9:case 10:case 11:case 12:return s([S,S,S,b,b,b,b,X,X,X]);default:return s([S,b,b,X,X])}};let B,C,R,I,P,L,$,A,j,O,q={};const z=()=>{document.getElementById("floor-hud").textContent=`${A}`,document.getElementById("coins-hud").textContent=`${j}`,document.getElementById("lives-hud").textContent=`${O}`},F=t=>{R.push(t),R.sort(((t,e)=>(e.sort||0)-(t.sort||0)))},K=(t,e)=>R.find((n=>n.x===t&&n.y===e)),T=t=>{R=R.filter((e=>e!==t))},W=(t,e)=>0===t||0===e||7===t||9===e;function _(){$=((e,n)=>{const o=[r(u,t),r(m,t)],a={name:"Knight",x:e,y:n,dir:0,draw:(...t)=>o[a.dir](...t)};return a})(2,2),P=!1,A=0,j=0,O=3,D()}function D(){I=!1,L=1.5,R=[],A++,z();const t=((t,e,n,o)=>{const r=[];for(let a=e;a<o;a++)for(let e=t;e<n;e++)r.push([e,a]);return i(r),r})(1,1,7,9).filter((([t,e])=>Math.abs(t-$.x)>1||Math.abs(e-$.y)>1)),[e,n]=t.pop();F({name:"Stairs",draw:(t,e,n)=>f(t,8,1,e,n),sort:10,x:e,y:n});((t,e)=>{const n=[];for(let e=0;e<t/5;e++)n.push(v);for(let e=0;e<(t-1)/2;e++)n.push(Y(t));return i(n),t%5==0&&n.unshift(E),n.slice(0,e/4)})(A,t.length).forEach((e=>{const[n,o]=t.pop();F(e(n,o))}))}window.addEventListener("keydown",(function(t){q[t.keyCode]=!0})),window.addEventListener("keyup",(function(t){q[t.keyCode]=!1})),(t=>{let e=null,n=null;document.addEventListener("touchstart",(t=>{const o=t.touches[0];e=o.clientX,n=o.clientY}),!1),document.addEventListener("touchmove",(o=>{if(!e||!n)return;const r=o.touches[0].clientX,a=o.touches[0].clientY,i=e-r,s=n-a;Math.abs(i)>Math.abs(s)?t(i>0?37:39):t(s>0?38:40),e=null,n=null}),!1)})((t=>{q[t]=!0})),window.addEventListener("load",(function(){B=((t,n,o,r)=>{const a=document.getElementById(t);e(a,n,o,r);const i=a.getContext("2d");return a.style.imageRendering="pixelated",i.imageSmoothingEnabled=!1,i})("root",128,160,3.5),C=o(d,t),_(),J()}));const G={37:()=>{W($.x-1,$.y)||$.x--,$.dir=1},38:()=>{W($.x,$.y-1)||$.y--},39:()=>{W($.x+1,$.y)||$.x++,$.dir=0},40:()=>{W($.x,$.y+1)||$.y++}};function H(t){"Stairs"===t.name&&(I=!0),"Coin"===t.name&&(j++,z(),T(t)),"Potion"===t.name&&(O++,z(),T(t)),"Slime"!==t.name&&"Bat"!==t.name&&"Skeleton"!==t.name||(O--,z(),O<=0&&(P=!0),T(t))}function J(){P||I||Object.entries(G).forEach((([t,e])=>{if(q[t]){q[t]=!1,e();const n=K($.x,$.y);n&&H(n),R.filter((t=>!!t.turn)).forEach((t=>{t.turn({me:t,player:$,floor:A}).forEach((e=>{"Move"===e.type&&(t.x=e.x,t.y=e.y),"Spawn"===e.type&&F(e.make(t.x,t.y))}))}));const o=K($.x,$.y);o&&H(o)}})),P&&L>.9&&Object.entries(G).forEach((([t])=>{q[t]&&(q[t]=!1,_())})),B.clearRect(0,0,128,160);for(let t=1;t<9;t++)for(let e=1;e<7;e++)C(B,1,1,e,t);C(B,0,0,0,0);for(let t=1;t<7;t++)C(B,1,0,t,0);C(B,2,0,7,0),C(B,0,2,0,9);for(let t=1;t<7;t++)C(B,1,2,t,9);C(B,2,2,7,9);for(let t=0;t<9;t++)C(B,0,1,0,t);for(let t=0;t<9;t++)C(B,2,1,7,t);R.forEach((t=>{const[e,n]=a(t);t.draw(B,e,n)}));const[t,e]=a($);$.draw(B,t,e),I?L<1?L+=Math.min(1-L,1/12):D():P?L<2&&(L+=Math.min(2-L,2/60)):L>0&&(L-=Math.min(L,1/12)),L>0&&(B.fillStyle=`rgba(39, 29, 42, ${L})`,B.fillRect(0,0,128,160),P&&(B.globalAlpha=L>1?L-1:0,C(B,17,1,3.5,4.5),B.globalAlpha=1)),requestAnimationFrame(J)}}));
