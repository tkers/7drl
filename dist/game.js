!function(t){"function"==typeof define&&define.amd?define(t):t()}((function(){"use strict";const t=16,n=function(t,n,e,o=1){const a=t.getContext("2d"),i=(t=>(window.devicePixelRatio||1)/(t.webkitBackingStorePixelRatio||t.mozBackingStorePixelRatio||t.msBackingStorePixelRatio||t.oBackingStorePixelRatio||t.backingStorePixelRatio||1))(a);return t.width=n*i,t.height=e*i,t.style.width="100%",t.style.maxWidth=n*o+"px",a.setTransform(i,0,0,i,0,0),t},e=(t,n)=>{const e=new Image;return e.src=t,n&&e.addEventListener("load",(()=>n(e)),!1),e},o=(t,n,e=n)=>(o,a,i,r,d)=>o.drawImage(t,a*n,i*e,n,e,r*n,d*e,n,e),a=(t,n,e=n)=>{const o=t.width/n;let a=Math.floor(Math.random()*o);if(o>0){setInterval((()=>{a=(a+1)%o}),125)}return(o,i,r)=>o.drawImage(t,a*n,0,n,e,i*n,r*e,n,e)},i=(t,n=.2)=>(void 0===t.drawX&&(t.drawX=t.x),void 0===t.drawY&&(t.drawY=t.y),t.drawX<t.x&&(t.drawX+=Math.min(t.x-t.drawX,n)),t.drawY<t.y&&(t.drawY+=Math.min(t.y-t.drawY,n)),t.drawX>t.x&&(t.drawX-=Math.min(t.drawX-t.x,n)),t.drawY>t.y&&(t.drawY-=Math.min(t.drawY-t.y,n)),[t.drawX,t.drawY]);const r=(t,n,e,o)=>{const a=[];for(let i=n;i<o;i++)for(let n=t;n<e;n++)a.push([n,i]);return function(t){for(var n=t.length-1;n>0;n--){var e=Math.floor(Math.random()*(n+1)),o=t[n];t[n]=t[e],t[e]=o}}(a),a},d=e("img/tiles.png"),l=e("img/bat.png"),c=e("img/skeleton.png"),s=e("img/knight.png"),m=e("img/knight_flip.png"),u=e("img/slime.png"),h=e("img/coin.png"),f=o(d,t),w=(t,n)=>{const e=[];return t>1&&e.push([t-1,n]),n>1&&e.push([t,n-1]),t<6&&e.push([t+1,n]),n<8&&e.push([t,n+1]),(o=e)[Math.floor(Math.random()*o.length)];var o},g=(t,n)=>({name:"Stairs",draw:(t,n,e)=>f(t,8,1,n,e),x:t,y:n}),x=(n,e)=>({name:"Coin",draw:a(h,t),x:n,y:e}),y=(n,e)=>({name:"Bat",draw:a(l,t),turn:w,x:n,y:e}),p=(n,e)=>({name:"Skeleton",draw:a(c,t),turn:w,x:n,y:e}),M=(n,e)=>({name:"Slime",draw:a(u,t),turn:w,x:n,y:e});let E,k,v,b,S,X,Y,B,C,R,I={};const L=()=>{document.getElementById("floor-hud").textContent=`${B}`,document.getElementById("coins-hud").textContent=`${C}`,document.getElementById("lives-hud").textContent=`${R}`},P=(t,n)=>v.find((e=>e.x===t&&e.y===n)),$=t=>{v=v.filter((n=>n!==t))};function A(){Y=((n,e)=>{const o=[a(s,t),a(m,t)],i={name:"Knight",x:n,y:e,dir:0,draw:(...t)=>o[i.dir](...t)};return i})(2,2),S=!1,B=0,C=0,R=3,j()}function j(){b=!1,X=1.5,B++,L();const t=r(1,1,7,9).filter((([t,n])=>Math.abs(t-Y.x)>1||Math.abs(n-Y.y)>1));v=[],[g,x,x,y,p,M].forEach((n=>{const[e,o]=t.pop();v.push(n(e,o))}))}window.addEventListener("keydown",(function(t){I[t.keyCode]=!0})),window.addEventListener("keyup",(function(t){I[t.keyCode]=!1})),(t=>{let n=null,e=null;document.addEventListener("touchstart",(t=>{const o=t.touches[0];n=o.clientX,e=o.clientY}),!1),document.addEventListener("touchmove",(o=>{if(!n||!e)return;const a=o.touches[0].clientX,i=o.touches[0].clientY,r=n-a,d=e-i;Math.abs(r)>Math.abs(d)?t(r>0?37:39):t(d>0?38:40),n=null,e=null}),!1)})((t=>{I[t]=!0})),window.addEventListener("load",(function(){E=((t,e,o,a)=>{const i=document.getElementById(t);n(i,e,o,a);const r=i.getContext("2d");return i.style.imageRendering="pixelated",r.imageSmoothingEnabled=!1,r})("root",128,160,3.5),k=o(d,t),A(),z()}));const O={37:()=>{Y.x>1&&Y.x--,Y.dir=1},38:()=>{Y.y>1&&Y.y--},39:()=>{Y.x<6&&Y.x++,Y.dir=0},40:()=>{Y.y<8&&Y.y++}};function q(t){"Stairs"===t.name&&(b=!0),"Coin"===t.name&&(C++,L(),$(t)),"Slime"!==t.name&&"Bat"!==t.name&&"Skeleton"!==t.name||(R--,L(),R<=0&&(S=!0),$(t))}function z(){S||b||Object.entries(O).forEach((([t,n])=>{if(I[t]){I[t]=!1,n();const e=P(Y.x,Y.y);e&&q(e),v.filter((t=>!!t.turn)).forEach((t=>{const[n,e]=t.turn(t.x,t.y);t.x=n,t.y=e}));const o=P(Y.x,Y.y);o&&q(o)}})),S&&X>.9&&Object.entries(O).forEach((([t])=>{I[t]&&(I[t]=!1,A())})),E.clearRect(0,0,128,160);for(let t=1;t<9;t++)for(let n=1;n<7;n++)k(E,1,1,n,t);k(E,0,0,0,0);for(let t=1;t<7;t++)k(E,1,0,t,0);k(E,2,0,7,0),k(E,0,2,0,9);for(let t=1;t<7;t++)k(E,1,2,t,9);k(E,2,2,7,9);for(let t=0;t<9;t++)k(E,0,1,0,t);for(let t=0;t<9;t++)k(E,2,1,7,t);v.forEach((t=>{const[n,e]=i(t);t.draw(E,n,e)}));const[t,n]=i(Y);Y.draw(E,t,n),b?X<1?X+=Math.min(1-X,1/12):j():S?X<2&&(X+=Math.min(2-X,2/60)):X>0&&(X-=Math.min(X,1/12)),X>0&&(E.fillStyle=`rgba(39, 29, 42, ${X})`,E.fillRect(0,0,128,160),S&&(E.globalAlpha=X>1?X-1:0,k(E,17,1,3.5,4.5),E.globalAlpha=1)),requestAnimationFrame(z)}}));
