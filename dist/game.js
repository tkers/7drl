!function(e){"function"==typeof define&&define.amd?define(e):e()}((function(){"use strict";const e=16,t=10,n=function(e,t,n,a=1){const r=e.getContext("2d"),o=(e=>(window.devicePixelRatio||1)/(e.webkitBackingStorePixelRatio||e.mozBackingStorePixelRatio||e.msBackingStorePixelRatio||e.oBackingStorePixelRatio||e.backingStorePixelRatio||1))(r);return e.width=t*o,e.height=n*o,e.style.width="100%",e.style.maxWidth=t*a+"px",r.setTransform(o,0,0,o,0,0),e},a=(e,t)=>{const n=new Image;return n.src=e,t&&n.addEventListener("load",(()=>t(n)),!1),n},r=(e,t,n=t)=>(a,r,o,s,i)=>a.drawImage(e,r*t,o*n,t,n,s*t,i*n,t,n),o=(e,t,n=t)=>{const a=e.width/t;let r=Math.floor(Math.random()*a);if(a>0){setInterval((()=>{r=(r+1)%a}),125)}return(a,o,s)=>a.drawImage(e,r*t,0,t,n,o*t,s*n,t,n)},s=(e,t=.2)=>(void 0===e.drawX&&(e.drawX=e.x),void 0===e.drawY&&(e.drawY=e.y),e.drawX<e.x&&(e.drawX+=Math.min(e.x-e.drawX,t)),e.drawY<e.y&&(e.drawY+=Math.min(e.y-e.drawY,t)),e.drawX>e.x&&(e.drawX-=Math.min(e.drawX-e.x,t)),e.drawY>e.y&&(e.drawY-=Math.min(e.drawY-e.y,t)),[e.drawX,e.drawY]);function i(e){for(var t=e.length-1;t>0;t--){var n=Math.floor(Math.random()*(t+1)),a=e[t];e[t]=e[n],e[n]=a}}const c=e=>e[Math.floor(Math.random()*e.length)],d=[[1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1]],l=[d];l.push([[2,1,1,1,1,1,1,2],[1,1,0,0,0,0,1,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,1,0,0,0,0,1,1],[2,1,1,1,1,1,1,2]]),l.push([[1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,1,1],[1,1,0,0,0,0,1,2],[2,1,0,0,0,0,1,1],[1,1,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1]]),l.push([[1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,1,1,0,0,1],[1,0,0,1,1,0,0,1],[1,0,0,1,1,0,0,1],[1,0,0,1,1,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1]]),l.push([[1,1,1,2,2,1,1,1],[1,0,1,1,1,1,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,1,1,0,0,1],[1,0,0,1,1,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,1,1,1,1,0,1],[1,1,1,2,2,1,1,1]]),l.push([[1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,1,0,0,0,0,1,1],[2,1,0,0,0,0,1,2],[2,1,0,0,0,0,1,2],[1,1,0,0,0,0,1,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1]]),l.push([[1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,1],[1,0,0,1,1,0,0,1],[1,0,0,1,1,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,1,1,0,0,1],[1,0,0,1,1,0,0,1],[1,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1]]),l.push([[2,2,2,2,1,1,1,1],[1,1,1,1,1,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,1,1,0,0,1],[1,0,0,1,1,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,1,1,1,1,1],[1,1,1,1,2,2,2,2]]),l.push([[1,1,1,1,1,1,2,2],[1,0,0,0,0,1,2,0],[1,0,0,0,0,1,2,2],[1,0,0,0,0,1,2,2],[1,0,0,0,0,1,1,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1]]),l.push([[2,1,1,1,1,1,1,1],[2,1,0,0,0,0,0,1],[2,1,0,0,0,0,0,1],[2,1,1,1,0,0,0,1],[2,2,2,1,0,0,0,1],[1,1,1,1,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,1,1,1],[1,1,1,1,1,1,2,2]]),l.push([[1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,1,0,0,0,0,1,1],[2,1,0,0,0,0,1,2],[2,1,0,0,0,0,1,2],[2,1,1,1,1,1,1,2]]),l.push([[1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,1,1,1],[1,0,0,0,0,1,2,2],[1,0,0,0,0,1,2,2],[1,0,0,0,0,1,1,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1]]),l.push([[1,1,1,1,1,1,2,2],[1,0,0,0,0,1,1,1],[1,0,1,1,0,0,0,1],[1,0,1,1,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,1,1,0,0,0,0,1],[2,2,1,1,1,1,1,1]]),l.push([[2,2,1,1,1,1,2,2],[1,1,1,0,0,1,1,1],[1,0,0,0,0,0,0,1],[1,0,0,1,1,0,0,1],[1,0,0,1,1,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1]]),l.push([[2,2,1,1,1,1,1,1],[1,1,1,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,1,1],[1,0,0,0,0,0,1,2],[1,0,0,0,0,0,1,1],[1,0,0,0,0,0,0,1],[1,1,0,0,0,0,0,1],[2,1,1,1,1,1,1,1]]),l.push([[1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,1,1,0,0,0,1],[1,0,1,1,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1]]),l.push([[2,2,1,1,1,1,1,1],[2,1,1,0,0,0,0,1],[2,1,0,0,0,0,0,1],[2,1,0,0,0,0,0,1],[2,1,0,0,0,0,0,1],[1,1,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1]]),l.push([[2,1,1,1,1,1,1,1],[1,1,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,1,1],[1,0,0,0,0,1,1,2],[1,0,0,0,0,1,2,2],[1,0,0,0,0,1,2,2],[1,1,1,1,1,1,2,2]]),l.push([[2,1,1,1,1,1,1,1],[1,1,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,1,1],[1,0,0,0,0,0,1,2],[1,0,0,0,0,0,1,1],[1,0,0,0,0,0,0,1],[1,1,1,0,0,0,0,1],[2,2,1,0,0,0,0,1],[2,2,1,1,1,1,1,1]]),l.push([[2,2,2,1,1,1,1,1],[1,1,1,1,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,1,1,0,1],[1,0,0,0,1,1,0,1],[1,0,0,0,1,1,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1]]);const u=a("img/tiles.png"),h=a("img/bat.png"),m=a("img/skeleton.png"),f=a("img/knight.png"),p=a("img/knight_flip.png"),y=a("img/slime.png"),g=a("img/coin.png"),x=a("img/potion.png"),w=a("img/trap.png"),v=a("img/torch.png"),M=r(u,e),E=(e,t)=>{const n=[[e.x-1,e.y],[e.x,e.y-1],[e.x+1,e.y],[e.x,e.y+1]].filter((([e,n])=>t(e,n))),a=c(n);return a&&{type:"Move",x:a[0],y:a[1]}},b=(e,t,n)=>{const a=[[e.x-1,e.y],[e.x,e.y-1],[e.x+1,e.y],[e.x,e.y+1],[e.x+(e.x>t.x?-1:1),e.y],[e.x,e.y+(e.y>t.y?-1:1)]].filter((([e,t])=>n(e,t))),r=c(a);return r&&{type:"Move",x:r[0],y:r[1]}},S=({me:e,isFreeAt:t})=>Math.random()>.5?[E(e,t)]:[],k=({me:e,player:t,isFreeAt:n})=>[b(e,t,n)],A=({me:e,isFreeAt:t})=>{const n=[];return e.grow++,8===e.grow&&n.push({type:"Spawn",make:P}),n.push(E(e,t)),n},B=(t,n)=>({name:"Coin",draw:o(g,e),sort:5,x:t,y:n}),I=(t,n)=>{const a=((e,t,n=t)=>{const a=e.width/t;let r=0,o=!1;a>0&&setInterval((()=>{(o||r>0)&&(o=!1,r=(r+1)%a)}),125);return{draw:(a,o,s)=>a.drawImage(e,r*t,0,t,n,o*t,s*n,t,n),activate:()=>{o=!0}}})(w,e);return{name:"Trap",draw:a.draw,isActive:!1,fase:Math.floor(3*Math.random()),turn:({me:e})=>(e.fase=(e.fase+1)%3,e.isActive=0===e.fase,e.isActive&&a.activate(),[]),sort:8,x:t,y:n}},C=(t,n)=>({name:"Potion",draw:o(x,e),sort:5,x:t,y:n}),X=(t,n)=>({name:"Bat",draw:o(h,e),turn:S,x:t,y:n}),Y=(t,n)=>({name:"Skeleton",draw:o(m,e),turn:k,x:t,y:n}),P=(t,n)=>({name:"Slime",draw:o(y,e),turn:A,grow:0,x:t,y:n}),R=e=>{switch(e){case 1:case 2:return X;case 3:case 4:case 5:return c([X,X,Y]);case 6:case 7:case 8:case 9:return c([X,X,Y,Y,I]);case 10:case 11:case 12:case 13:case 14:return c([X,X,X,X,Y,Y,Y,Y,Y,P,I,I]);case 15:case 16:case 17:case 18:case 19:return c([X,X,X,Y,Y,Y,Y,Y,P,P,I,I]);default:return c([X,X,Y,Y,Y,Y,P,P,P,I])}};let L,F,T,$,D,O,j,q,z,K,W,_,G,H,J={},N=0;const Q=()=>{document.getElementById("floor-hud").textContent=`${q}`,document.getElementById("coins-hud").textContent=`${z}`,document.getElementById("lives-hud").textContent=`${K}`},U=()=>{K--,Q(),N=1,G=j.x,H=j.y,K<=0&&(D=!0)},V=e=>{T.push(e),T.sort(((e,t)=>(t.sort||0)-(e.sort||0)))},Z=(e,t)=>T.find((n=>n.x===e&&n.y===t)),ee=e=>{T=T.filter((t=>t!==e))},te=(e,n)=>e>=0&&n>=0&&e<8&&n<t&&1===W[n][e],ne=(e,n)=>e>=0&&n>=0&&e<8&&n<t&&0===W[n][e],ae=(e,t)=>{if(te(e,t))return!1;const n=Z(e,t);return!n||"Stairs"!==n.name},re=16,oe=64,se=128,ie=e=>{if(!e)return!1;const[t,n]=e;return 1===t&&0===n||3===t&&1===n||4===t&&1===n},ce=(e,t)=>ne(e,t)?[1,1]:te(e,t)?((e,t)=>{switch((te(e,t-1)?1:0)+(ne(e,t-1)?2:0)+(te(e+1,t)?4:0)+(ne(e+1,t)?8:0)+(te(e,t+1)?re:0)+(ne(e,t+1)?32:0)+(te(e-1,t)?oe:0)+(ne(e-1,t)?se:0)){case 20:return[0,0];case 100:return[1,0];case 80:return[2,0];case 25:case 89:return[0,1];case 145:case 149:return[2,1];case 5:return[0,2];case 70:case 86:return[1,2];case 65:return[2,2];case 150:return[3,0];case 90:return[4,0];case 165:return[3,1];case 105:return[4,1];default:return[1,0]}})(e,t):null;function de(){j=((t,n)=>{const a=[o(f,e),o(p,e)],r={name:"Knight",x:t,y:n,dir:0,draw:(...e)=>a[r.dir](...e)};return r})(2,2),D=!1,q=0,z=0,K=5,le()}function le(){$=!1,O=1.5,T=[],q++,Q(),W=((e,t,n)=>e<=3?d:c(l.filter((e=>0===e[n][t]))))(q,j.x,j.y),_=[];const n=[];for(let e=0;e<t;e++){_[e]=[];for(let t=0;t<8;t++){const a=ce(t,e);_[e].push(a),ie(a)&&n.push([t,e])}}i(n),n.slice(0,Math.random()*n.length/2.2).forEach((([t,n])=>V(((t,n)=>({name:"Torch",draw:o(v,e),sort:2,x:t,y:n}))(t,n))));const a=((e,t,n,a)=>{const r=[];for(let o=t;o<a;o++)for(let t=e;t<n;t++)r.push([t,o]);return i(r),r})(0,0,8,t).filter((([e,t])=>ne(e,t))).filter((([e,t])=>Math.abs(e-j.x)>1||Math.abs(t-j.y)>1)),[r,s]=a.pop();V({name:"Stairs",draw:(e,t,n)=>M(e,8,1,t,n),sort:10,x:r,y:s});((e,t)=>{const n=[];for(let t=0;t<e/5;t++)n.push(B);for(let t=0;t<e-1;t++)n.push(R(e));i(n),e%5==0&&n.unshift(C);const a=Math.min(e<4?e:3+e/4,t/4.5);return n.slice(0,a)})(q,a.length).forEach((e=>{const[t,n]=a.pop();V(e(t,n))}))}window.addEventListener("keydown",(function(e){J[e.keyCode]=!0})),window.addEventListener("keyup",(function(e){J[e.keyCode]=!1})),(e=>{let t=null,n=null;document.addEventListener("touchstart",(e=>{const a=e.touches[0];t=a.clientX,n=a.clientY}),!1),document.addEventListener("touchmove",(a=>{if(!t||!n)return;const r=a.touches[0].clientX,o=a.touches[0].clientY,s=t-r,i=n-o;Math.abs(s)>Math.abs(i)?e(s>0?37:39):e(i>0?38:40),t=null,n=null}),!1)})((e=>{J[e]=!0})),window.addEventListener("load",(function(){L=((e,t,a,r)=>{const o=document.getElementById(e);n(o,t,a,r);const s=o.getContext("2d");return o.style.imageRendering="pixelated",s.imageSmoothingEnabled=!1,s})("root",128,160,3.5),F=r(u,e),de(),ge()}));const ue=()=>{te(j.x-1,j.y)||j.x--,j.dir=1},he=()=>{te(j.x,j.y-1)||j.y--},me=()=>{te(j.x+1,j.y)||j.x++,j.dir=0},fe=()=>{te(j.x,j.y+1)||j.y++},pe={37:ue,38:he,39:me,40:fe,72:ue,74:fe,75:he,76:me};function ye(e,t){"Stairs"===e.name&&($=!0,(()=>{const e=document.getElementById("extra-hud");e.style.opacity="0",e.style.pointerEvents="none"})()),"Coin"===e.name&&(z++,Q(),ee(e)),"Potion"===e.name&&(K++,Q(),ee(e)),"Trap"===e.name&&e.isActive&&!t&&U(),"Slime"!==e.name&&"Bat"!==e.name&&"Skeleton"!==e.name||(U(),ee(e))}function ge(){D||$||Object.entries(pe).forEach((([e,t])=>{if(J[e]){J[e]=!1,t();const n=Z(j.x,j.y);n&&ye(n,!0),T.filter((e=>!!e.turn&&!e.isDead)).forEach((e=>{if(e.turn({me:e,player:j,floor:q,isFreeAt:ae,getEntityAt:Z}).forEach((t=>{"Move"===t.type&&(e.x=t.x,e.y=t.y),"Spawn"===t.type&&V(t.make(e.x,e.y))})),"Bat"===e.name||"Skeleton"===e.name||"Slime"===e.name){const t=Z(e.x,e.y);t&&"Trap"===t.name&&t.isActive&&!e.isDead&&(e.isDead=!0,e.fade=1)}}));const a=Z(j.x,j.y);a&&ye(a,!1)}})),D&&O>1.5&&Object.entries(pe).forEach((([e])=>{J[e]&&(J[e]=!1,de())})),L.clearRect(0,0,128,160);for(let e=0;e<t;e++)for(let t=0;t<8;t++){const n=_[e][t];n&&F(L,n[0],n[1],t,e)}const n=[];T.forEach((e=>{const[t,a]=s(e);e.isDead&&(e.fade>0?e.fade-=Math.min(e.fade,1/60):n.push(e),L.globalAlpha=e.fade),e.draw(L,t,a),L.globalAlpha=1})),n.forEach(ee);const[a,r]=s(j);j.draw(L,a,r),N>0&&(N-=Math.min(N,1/36),L.fillStyle=`rgba(250, 0, 0, ${N/2})`,L.globalCompositeOperation="overlay",L.beginPath(),L.arc((G+.5)*e,(H+.5)*e,9.6,0,2*Math.PI),L.fill(),L.globalCompositeOperation="source-over"),$?O<1?O+=Math.min(1-O,1/12):le():D?O<2&&(O+=Math.min(2-O,2/60)):O>0&&(O-=Math.min(O,1/12)),O>0&&(L.fillStyle=`rgba(39, 29, 42, ${O})`,L.fillRect(0,0,128,160),D&&(L.globalAlpha=O>1?O-1:0,F(L,17,1,3.5,4.5),L.globalAlpha=1)),requestAnimationFrame(ge)}}));
