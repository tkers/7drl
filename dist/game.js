!function(t){"function"==typeof define&&define.amd?define(t):t()}((function(){"use strict";const t=16,n=function(t,n,e,o=1){const a=t.getContext("2d"),r=(t=>(window.devicePixelRatio||1)/(t.webkitBackingStorePixelRatio||t.mozBackingStorePixelRatio||t.msBackingStorePixelRatio||t.oBackingStorePixelRatio||t.backingStorePixelRatio||1))(a);return t.width=n*r,t.height=e*r,t.style.width="100%",t.style.maxWidth=n*o+"px",a.setTransform(r,0,0,r,0,0),t},e=(t,n)=>{const e=new Image;return e.src=t,n&&e.addEventListener("load",(()=>n(e)),!1),e},o=(t,n,e=n)=>(o,a,r,i,d)=>o.drawImage(t,a*n,r*e,n,e,i*n,d*e,n,e),a=(t,n,e=n)=>{const o=t.width/n;let a=Math.floor(Math.random()*o);if(o>0){setInterval((()=>{a=(a+1)%o}),125)}return(o,r,i)=>o.drawImage(t,a*n,0,n,e,r*n,i*e,n,e)},r=(t,n=.2)=>(void 0===t.drawX&&(t.drawX=t.x),void 0===t.drawY&&(t.drawY=t.y),t.drawX<t.x&&(t.drawX+=Math.min(t.x-t.drawX,n)),t.drawY<t.y&&(t.drawY+=Math.min(t.y-t.drawY,n)),t.drawX>t.x&&(t.drawX-=Math.min(t.drawX-t.x,n)),t.drawY>t.y&&(t.drawY-=Math.min(t.drawY-t.y,n)),[t.drawX,t.drawY]);const i=(t,n,e,o)=>{const a=[];for(let r=n;r<o;r++)for(let n=t;n<e;n++)a.push([n,r]);return function(t){for(var n=t.length-1;n>0;n--){var e=Math.floor(Math.random()*(n+1)),o=t[n];t[n]=t[e],t[e]=o}}(a),a},d=e("img/tiles.png"),c=e("img/bat.png"),l=e("img/skeleton.png"),s=e("img/knight.png"),m=e("img/knight_flip.png"),u=e("img/slime.png"),h=e("img/coin.png"),f=o(d,t),w=(t,n)=>{const e=[];return t>1&&e.push([t-1,n]),n>1&&e.push([t,n-1]),t<6&&e.push([t+1,n]),n<8&&e.push([t,n+1]),(o=e)[Math.floor(Math.random()*o.length)];var o},g=(t,n)=>({name:"Stairs",draw:(t,n,e)=>f(t,8,1,n,e),x:t,y:n}),x=(n,e)=>({name:"Coin",draw:a(h,t),x:n,y:e}),y=(n,e)=>({name:"Bat",draw:a(c,t),turn:w,x:n,y:e}),p=(n,e)=>({name:"Skeleton",draw:a(l,t),turn:w,x:n,y:e}),M=(n,e)=>({name:"Slime",draw:a(u,t),turn:w,x:n,y:e});let k,v,E,S,X,Y,b={},B=0,C=0,R=3;const I=(t,n)=>E.find((e=>e.x===t&&e.y===n)),L=t=>{E=E.filter((n=>n!==t))};function P(){S=!1,X=1.5,B++,document.getElementById("floor-hud").textContent=`${B}`;const t=i(1,1,7,9).filter((([t,n])=>Math.abs(t-Y.x)>1||Math.abs(n-Y.y)>1));E=[],[g,x,x,y,p,M].forEach((n=>{const[e,o]=t.pop();E.push(n(e,o))}))}window.addEventListener("keydown",(function(t){b[t.keyCode]=!0})),window.addEventListener("keyup",(function(t){b[t.keyCode]=!1})),(t=>{let n=null,e=null;document.addEventListener("touchstart",(t=>{const o=t.touches[0];n=o.clientX,e=o.clientY}),!1),document.addEventListener("touchmove",(o=>{if(!n||!e)return;const a=o.touches[0].clientX,r=o.touches[0].clientY,i=n-a,d=e-r;Math.abs(i)>Math.abs(d)?t(i>0?37:39):t(d>0?38:40),n=null,e=null}),!1)})((t=>{b[t]=!0})),window.addEventListener("load",(function(){k=((t,e,o,a)=>{const r=document.getElementById(t);n(r,e,o,a);const i=r.getContext("2d");return r.style.imageRendering="pixelated",i.imageSmoothingEnabled=!1,i})("root",128,160,3.5),v=o(d,t),Y=((n,e)=>{const o=[a(s,t),a(m,t)],r={name:"Knight",x:n,y:e,dir:0,draw:(...t)=>o[r.dir](...t)};return r})(2,2),P(),q()}));const $={37:()=>{Y.x>1&&Y.x--,Y.dir=1},38:()=>{Y.y>1&&Y.y--},39:()=>{Y.x<6&&Y.x++,Y.dir=0},40:()=>{Y.y<8&&Y.y++}};function j(t){"Stairs"===t.name&&(S=!0),"Coin"===t.name&&(C++,document.getElementById("coins-hud").textContent=`${C}`,L(t)),"Slime"!==t.name&&"Bat"!==t.name&&"Skeleton"!==t.name||(R--,document.getElementById("lives-hud").textContent=`${R}`,L(t))}function q(){S||Object.entries($).forEach((([t,n])=>{if(b[t]){b[t]=!1,n();const e=I(Y.x,Y.y);e&&j(e),E.filter((t=>!!t.turn)).forEach((t=>{const[n,e]=t.turn(t.x,t.y);t.x=n,t.y=e}));const o=I(Y.x,Y.y);o&&j(o)}})),k.clearRect(0,0,128,160);for(let t=1;t<9;t++)for(let n=1;n<7;n++)v(k,1,1,n,t);v(k,0,0,0,0);for(let t=1;t<7;t++)v(k,1,0,t,0);v(k,2,0,7,0),v(k,0,2,0,9);for(let t=1;t<7;t++)v(k,1,2,t,9);v(k,2,2,7,9);for(let t=0;t<9;t++)v(k,0,1,0,t);for(let t=0;t<9;t++)v(k,2,1,7,t);E.forEach((t=>{const[n,e]=r(t);t.draw(k,n,e)}));const[t,n]=r(Y);Y.draw(k,t,n),S?X<1?X+=Math.min(1-X,1/12):P():X>0&&(X-=Math.min(X,1/12)),X>0&&(k.fillStyle=`rgba(39, 29, 42, ${X})`,k.fillRect(0,0,128,160)),requestAnimationFrame(q)}}));
