!function(t){"function"==typeof define&&define.amd?define(t):t()}((function(){"use strict";const t=16,e=function(t,e,n,o=1){const a=t.getContext("2d"),r=(t=>(window.devicePixelRatio||1)/(t.webkitBackingStorePixelRatio||t.mozBackingStorePixelRatio||t.msBackingStorePixelRatio||t.oBackingStorePixelRatio||t.backingStorePixelRatio||1))(a);return t.width=e*r,t.height=n*r,t.style.width="100%",t.style.maxWidth=e*o+"px",a.setTransform(r,0,0,r,0,0),t},n=(t,e)=>{const n=new Image;return n.src=t,e&&n.addEventListener("load",(()=>e(n)),!1),n},o=(t,e,n=e)=>(o,a,r,i,d)=>o.drawImage(t,a*e,r*n,e,n,i*e,d*n,e,n),a=(t,e,n=e)=>{const o=t.width/e;let a=Math.floor(Math.random()*o);if(o>0){setInterval((()=>{a=(a+1)%o}),125)}return(o,r,i)=>o.drawImage(t,a*e,0,e,n,r*e,i*n,e,n)},r=(t,e=.2)=>(void 0===t.drawX&&(t.drawX=t.x),void 0===t.drawY&&(t.drawY=t.y),t.drawX<t.x&&(t.drawX+=Math.min(t.x-t.drawX,e)),t.drawY<t.y&&(t.drawY+=Math.min(t.y-t.drawY,e)),t.drawX>t.x&&(t.drawX-=Math.min(t.drawX-t.x,e)),t.drawY>t.y&&(t.drawY-=Math.min(t.drawY-t.y,e)),[t.drawX,t.drawY]);function i(t){for(var e=t.length-1;e>0;e--){var n=Math.floor(Math.random()*(e+1)),o=t[e];t[e]=t[n],t[n]=o}}const d=t=>t[Math.floor(Math.random()*t.length)],l=n("img/tiles.png"),s=n("img/bat.png"),c=n("img/skeleton.png"),h=n("img/knight.png"),u=n("img/knight_flip.png"),m=n("img/slime.png"),y=n("img/coin.png"),x=n("img/potion.png"),f=o(l,t),p=t=>{const e=[];t.x>1&&e.push([t.x-1,t.y]),t.y>1&&e.push([t.x,t.y-1]),t.x<6&&e.push([t.x+1,t.y]),t.y<8&&e.push([t.x,t.y+1]);const n=d(e);return n&&{type:"Move",x:n[0],y:n[1]}},g=(t,e)=>{const n=[];t.x>1&&t.x>e.x&&n.push([t.x-1,t.y]),t.y>1&&t.y>e.y&&n.push([t.x,t.y-1]),t.x<6&&t.x<e.x&&n.push([t.x+1,t.y]),t.y<8&&t.y<e.y&&n.push([t.x,t.y+1]);const o=d(n);return o&&{type:"Move",x:o[0],y:o[1]}},w=({me:t})=>Math.random()>.5?[p(t)]:[],M=({me:t,player:e})=>Math.random()>.7?[g(t,e)]:[p(t)],k=({me:t,floor:e})=>{console.log({floor:e});const n=[];return t.grow++,5===t.grow&&n.push({type:"Spawn",make:b}),n.push(p(t)),n},v=(e,n)=>({name:"Coin",draw:a(y,t),x:e,y:n}),E=(e,n)=>({name:"Bat",draw:a(s,t),turn:w,x:e,y:n}),S=(e,n)=>({name:"Skeleton",draw:a(c,t),turn:M,x:e,y:n}),b=(e,n)=>({name:"Slime",draw:a(m,t),turn:k,grow:0,x:e,y:n});let X,Y,B,C,R,I,P,L,$,A,j={};const O=()=>{document.getElementById("floor-hud").textContent=`${L}`,document.getElementById("coins-hud").textContent=`${$}`,document.getElementById("lives-hud").textContent=`${A}`},q=(t,e)=>B.find((n=>n.x===t&&n.y===e)),z=t=>{B=B.filter((e=>e!==t))};function F(){P=((e,n)=>{const o=[a(h,t),a(u,t)],r={name:"Knight",x:e,y:n,dir:0,draw:(...t)=>o[r.dir](...t)};return r})(2,2),R=!1,L=0,$=0,A=3,K()}function K(){C=!1,I=1.5,B=[],L++,O();const e=((t,e,n,o)=>{const a=[];for(let r=e;r<o;r++)for(let e=t;e<n;e++)a.push([e,r]);return i(a),a})(1,1,7,9).filter((([t,e])=>Math.abs(t-P.x)>1||Math.abs(e-P.y)>1)),[n,o]=e.pop();if(B.push({name:"Stairs",draw:(t,e,n)=>f(t,8,1,e,n),x:n,y:o}),L%5==0){const[n,o]=e.pop();B.push(((e,n)=>({name:"Potion",draw:a(x,t),x:e,y:n}))(n,o))}const r=[];for(let t=0;t<L;t++)r.push(v);for(let t=0;t<L-1;t++)r.push(E);for(let t=0;t<L-2;t++)r.push(S);for(let t=0;t<L-3;t++)r.push(b);i(r),r.slice(0,e.length/3).forEach((t=>{const[n,o]=e.pop();B.push(t(n,o))}))}window.addEventListener("keydown",(function(t){j[t.keyCode]=!0})),window.addEventListener("keyup",(function(t){j[t.keyCode]=!1})),(t=>{let e=null,n=null;document.addEventListener("touchstart",(t=>{const o=t.touches[0];e=o.clientX,n=o.clientY}),!1),document.addEventListener("touchmove",(o=>{if(!e||!n)return;const a=o.touches[0].clientX,r=o.touches[0].clientY,i=e-a,d=n-r;Math.abs(i)>Math.abs(d)?t(i>0?37:39):t(d>0?38:40),e=null,n=null}),!1)})((t=>{j[t]=!0})),window.addEventListener("load",(function(){X=((t,n,o,a)=>{const r=document.getElementById(t);e(r,n,o,a);const i=r.getContext("2d");return r.style.imageRendering="pixelated",i.imageSmoothingEnabled=!1,i})("root",128,160,3.5),Y=o(l,t),F(),_()}));const T={37:()=>{P.x>1&&P.x--,P.dir=1},38:()=>{P.y>1&&P.y--},39:()=>{P.x<6&&P.x++,P.dir=0},40:()=>{P.y<8&&P.y++}};function W(t){"Stairs"===t.name&&(C=!0),"Coin"===t.name&&($++,O(),z(t)),"Potion"===t.name&&(A++,O(),z(t)),"Slime"!==t.name&&"Bat"!==t.name&&"Skeleton"!==t.name||(A--,O(),A<=0&&(R=!0),z(t))}function _(){R||C||Object.entries(T).forEach((([t,e])=>{if(j[t]){j[t]=!1,e();const n=q(P.x,P.y);n&&W(n),B.filter((t=>!!t.turn)).forEach((t=>{t.turn({me:t,player:P,floor:L}).forEach((e=>{"Move"===e.type&&(t.x=e.x,t.y=e.y),"Spawn"===e.type&&B.push(e.make(t.x,t.y))}))}));const o=q(P.x,P.y);o&&W(o)}})),R&&I>.9&&Object.entries(T).forEach((([t])=>{j[t]&&(j[t]=!1,F())})),X.clearRect(0,0,128,160);for(let t=1;t<9;t++)for(let e=1;e<7;e++)Y(X,1,1,e,t);Y(X,0,0,0,0);for(let t=1;t<7;t++)Y(X,1,0,t,0);Y(X,2,0,7,0),Y(X,0,2,0,9);for(let t=1;t<7;t++)Y(X,1,2,t,9);Y(X,2,2,7,9);for(let t=0;t<9;t++)Y(X,0,1,0,t);for(let t=0;t<9;t++)Y(X,2,1,7,t);B.forEach((t=>{const[e,n]=r(t);t.draw(X,e,n)}));const[t,e]=r(P);P.draw(X,t,e),C?I<1?I+=Math.min(1-I,1/12):K():R?I<2&&(I+=Math.min(2-I,2/60)):I>0&&(I-=Math.min(I,1/12)),I>0&&(X.fillStyle=`rgba(39, 29, 42, ${I})`,X.fillRect(0,0,128,160),R&&(X.globalAlpha=I>1?I-1:0,Y(X,17,1,3.5,4.5),X.globalAlpha=1)),requestAnimationFrame(_)}}));
